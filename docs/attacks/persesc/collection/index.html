<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Collection - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="http://localhost:1313/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-ttp üîç">
      <a href="/docs/ttp">
        <span>TTP üîç</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db üè∫">
      <a href="/docs/artefacts">
        <span>Artefacts DB üè∫</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ‚öîÔ∏è">
      <a href="/docs/attacks">
        <span>Attacks DB ‚öîÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tools db üõ†Ô∏è">
      <a href="/docs/tools">
        <span>Tools DB üõ†Ô∏è</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="http://localhost:1313/"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="http://localhost:1313/"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-ttp üîç">
      <a href="/docs/ttp">
        <span>TTP üîç</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db üè∫">
      <a href="/docs/artefacts">
        <span>Artefacts DB üè∫</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ‚öîÔ∏è">
      <a href="/docs/attacks">
        <span>Attacks DB ‚öîÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tools db üõ†Ô∏è">
      <a href="/docs/tools">
        <span>Tools DB üõ†Ô∏è</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/attacks/persesc/"> üëàüèº Back to </br> Persistence and Escalation Mechanisms </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#windows">Windows</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Collection</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      

      
      

      
    </div>
    
    <b>Created:</b> 03.06.2023
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <p>*There are a lot of techniques to become persistent on a Windows machine. You can refer to the persistence and escalation mechanisms article or look those up on the MITRE website. Although it&rsquo;s important to know the artefacts themselves and the technique, it would be hard to collect them all manually. *</p>
<h2 id="windows">Windows</h2>
<p>To collect autorun artefacts on Windows, run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>autorunsc -v <span style="color:#f92672">[</span>options<span style="color:#f92672">]</span> &gt; result.csv
</span></span></code></pre></div><p>Run a tool to collect all the artefacts for this OS (for example, <code>autorunc.exe</code> for Windows) on the machines in question. I use CSV format as output whenever possible because it can be imported in a SIEM, TimeLine Explorer (Windows) or Numbers/Excel/Google Sheets. I prefer the last option because its pivoting functionality is much easier to deploy.</p>
<ol>
<li>Open each file (if there are not too many)
<ol>
<li>Filter for untrusted or missing vendors. Such vendors as Google and Firefox might be used to trick the user. It would look like `(Not verified) Firefox.</li>
<li>Show those enabled ones (if applicable)</li>
<li>Look at the image path, and use the FindEvil SANS poster or your baseline system profile as a reference for known good to find what&rsquo;s bad</li>
<li>Look at the hashes and check against known-good.</li>
<li>Check with a supernova, google Publishes and Description</li>
<li>Frequency analysis. What stands out? (see the following sections). Find possible suspicious or malicious things.</li>
<li>Check the triage files from other machines for the same IoCs (<code>Select-String</code>, <code>grep</code> etc).</li>
</ol>
</li>
<li>Stacking (frequency-based outlier analysis)</li>
<li>Frequency analysis. What stands out? (see the following sections)</li>
</ol>
<blockquote>
<p>üóí  If the file doesn&rsquo;t have an image path (File not found), it&rsquo;s likely it was moved/deleted and thus is not an active threat.</p></blockquote>
<p>What&rsquo;s suspicious?</p>
<ul>
<li>Non-system executables like OneDrive are in the <code>System32</code> directory (Windows) or not in <code>Applications</code> (macOS) or <code>/opt</code> (Linux).</li>
<li>Files with meaningless names and usually one letter or 1 number like <code>1.bat</code> or <code>2.exe</code> or <code>a.exe</code>.</li>
<li>Be especially careful with drivers/daemons since they have the most power.</li>
<li>WMI entries are also worth checking (Windows only)</li>
<li>Executables and scripts in a temp directory</li>
</ul>
<p>Kansa PowerShell script <code>Get-ASEPImagePathLaunchStringMD5UnsignedStack.ps1</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">&lt;#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">.</span><span style="color:#e6db74">SYNOPSIS</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get-ASEPImagePathLaunchStringStack.ps1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Requires logparser.exe in path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pulls frequency of autoruns based on ImagePath, LaunchString and MD5 tuple
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">where the publisher is not verified (unsigned code) and the ImagePath is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">not &#39;File not found&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">This script expects files matching the *autorunsc.txt pattern to be in the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">current working directory.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">.</span><span style="color:#e6db74">NOTES</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">DATADIR Autorunsc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (Get-Command LogParser.exe) {
</span></span><span style="display:flex;"><span>    $lpquery = <span style="color:#e6db74">@&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        COUNT([Image Path], [Launch String], MD5) as ct,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Image Path],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Launch String],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        MD5,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Signer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FROM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        *autorunsc.csv
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    WHERE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Signer not like &#39;(Verified)%&#39; and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ([Image Path] not like &#39;File not found%&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    GROUP BY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Image Path],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Launch String],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        MD5,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Signer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ORDER BY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ct ASC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    &amp; logparser -stats:off -i:csv -dtlines:<span style="color:#ae81ff">0</span> -o:csv <span style="color:#e6db74">&#34;</span>$lpquery<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    $ScriptName = [<span style="color:#66d9ef">System.IO.Path</span>]::GetFileName($MyInvocation.ScriptName)
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;</span>${ScriptName}<span style="color:#e6db74"> requires logparser.exe in the path.&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><a href="https://www.microsoft.com/en-gb/download/details.aspx?id=24659">Logparser</a> needs to be installed for it to run. Run this script in the directory with the <code>*-Autorunsc.csv</code> files. It will merge all the info into one file. Perform frequency analysis against this consolidated data and note anything run on one system only (sort or filter by the <code>cnt</code> column). Once the processes of interest have been identified, run the Powershell script to see which machine this process was run on:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Select-String <span style="color:#e6db74">&#34;processname&#34;</span> *-Autorunsc.csv
</span></span></code></pre></div><p>There is also a <code>Get-LogparserStack.ps1</code> script which is more general and allows you to parse and merge different logs so long as they have the same structure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\Get-LogparserStack.ps1 -FilePattern *SvcAll.csv -Delimiter <span style="color:#e6db74">&#34;,&#34;</span> -Direction asc -OutFile SvcAll-workstation-stack.csv
</span></span></code></pre></div><p>You will be asked to <code>Enter the field to pass to COUNT()</code>. This needs to be some column that identifies the processes uniquely, not the row! For example, it&rsquo;s the process <strong>name</strong>. Then you will be prompted to <code>Enter the fields you want to GROUP BY, one per line. Enter &quot;quit&quot; when finished</code>.  You can group by any column and also combine several of them. For example, group by Name, DisplayName and Path (for some process logs) or by IP and user id for some application logs.</p>
<blockquote>
<p><em>When you specify columns to group by using the &ldquo;GROUP BY&rdquo; option in the script, Log Parser will group all log entries that have the same value for the specified columns into a single group. The script then calculates the number of hits and bytes transferred for each group. ChatGPT</em></p></blockquote>
<p>You&rsquo;ll see the columns specified as <code>GROUP BY</code> options in the output. So, for example, in the case of some <code>accesslogs.txt</code> files, we can group by method, URL and HTTP status code returned. That means the script will group all entries where the method, URL and status code are the same, <em>then</em> calculate the number of entries there and <em>then</em> list the aggregated results. It&rsquo;s something like pivot tables in Excel or Numbers.</p>
<p>See more here - <a href="https://trustedsignal.blogspot.com/2015/03/kansa-get-logparserstackps1.html">https://trustedsignal.blogspot.com/2015/03/kansa-get-logparserstackps1.html</a>.</p>
<p>When the entries of interest are found, use <code>Select-String &lt;full-or-partial-entry-name&gt;</code> in the folder with all the <code>csv</code> files to find machines with the suspicious artefact.</p>
<h2 id="references">References</h2>
<details>
    <summary>Expand&hellip;</summary>
    Something here
</details>
  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.js"></script>
  

  


</body>

</html>
